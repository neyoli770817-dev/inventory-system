<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4A0404">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…«æ¯…åº«å­˜ç®¡ç†ç³»çµ±</title>
    <link rel="apple-touch-icon" href="https://i.postimg.cc/XNCSk29x/å…«æ¯…LOGO.jpg">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg-wine: #4A0404; --btn-white: #FFFFFF; --text-dark: #333; }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg-wine); color: white; margin: 0; padding: 10px; }
        .page { display: none; padding-bottom: 80px; } .page.active { display: block; }
        .header { text-align: center; padding: 15px 0; background: var(--bg-wine); position: sticky; top: 0; z-index: 100; }
        .mode-container { display: flex; flex-direction: column; gap: 20px; align-items: center; justify-content: center; height: 80vh; }
        .mode-btn { width: 80%; padding: 40px; border-radius: 20px; font-size: 30px; font-weight: bold; border: none; cursor: pointer; color: white; }
        .btn-out { background: #E91E63; } .btn-in { background: #4CAF50; }  
        .form-container { max-width: 500px; margin: 0 auto 15px auto; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; }
        .form-control { width: 100%; padding: 10px; border-radius: 8px; border: none; font-size: 16px; box-sizing: border-box; margin-bottom: 10px; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 500px; margin: 0 auto; }
        .menu-item { background: var(--btn-white); aspect-ratio: 1/1; border-radius: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; padding: 10px; }
        .menu-item img { width: 60px !important; height: 60px !important; object-fit: contain; }
        .menu-item span { color: var(--text-dark); font-weight: bold; font-size: 16px; margin-top: 5px; }
        .item-card { background: white; color: var(--text-dark); border-radius: 12px; padding: 15px; margin-bottom: 10px; }
        .qty-input-group { display: flex; align-items: center; gap: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .input-num { width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 5px; text-align: center; font-size: 18px; }
        .submit-btn { flex: 1; color: white; border: none; padding: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .back-btn { background: none; border: 1px solid white; color: white; padding: 8px 12px; margin-bottom: 10px; border-radius: 5px; cursor: pointer; }
        .batch-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #222; padding: 15px; z-index: 999; text-align: center; }
        .batch-btn { width: 90%; max-width: 500px; padding: 15px; border-radius: 10px; font-size: 18px; font-weight: bold; border: none; color: white; cursor: pointer; }
        /* åˆ†å€å°æ¨™é¡Œ */
        .sub-header { color: #FFD700; font-size: 18px; font-weight: bold; padding: 10px 0; border-bottom: 2px solid #FFD700; margin: 20px 0 10px 0; display: block; width: 100%; }
    </style>
</head>
<body>

    <div id="modePage" class="page active">
        <div class="header"><h1>å…«æ¯…åº«å­˜ç³»çµ±</h1></div>
        <div class="mode-container">
            <button class="mode-btn btn-out" onclick="setMode('å–ç”¨')">ğŸ“¤ å‡ºåº« (æ‹¿å–)</button>
            <button class="mode-btn btn-in" onclick="setMode('å…¥åº«')">ğŸ“¥ å…¥åº« (æ­¸é‚„)</button>
            <button class="back-btn" onclick="showSummary()" style="width:80%; font-size:20px;">ğŸ“Š æŸ¥çœ‹åº«å­˜ç¸½é‡</button>
        </div>
    </div>

    <div id="homePage" class="page">
        <div class="header"><button class="back-btn" onclick="location.reload()">â† å›é¦–é </button><h1 id="modeTitle"></h1></div>
        <div class="form-container">
            <select id="userName" class="form-control" onchange="saveUser(this.value)"> 
                <option value="">ğŸ‘¤ é¸æ“‡äººå“¡...</option>
                <option>é‚±æ­£è±ª</option><option>é‚±å®¥ç‘‹</option><option>å»–æ†å…‰</option><option>æ—ç¿</option><option>è‘£å¤èˆœ</option><option>é»å…‰åº­</option>
            </select>
            <input type="date" id="actionDate" class="form-control">
            <input type="text" id="eventTag" class="form-control" placeholder="ğŸ“ å ´æ¬¡åç¨± / å‚™è¨»">
        </div>
        <div class="menu-grid">
            <div class="menu-item" onclick="openCategory('truss')"><img src="https://i.postimg.cc/GtDsw45n/OIP.png"><span>Trussé¡</span></div>
            <div class="menu-item" onclick="openCategory('tent')"><img src="https://i.postimg.cc/KYxJNfXy/3tent001.png"><span>å¸³ç¯·é¡</span></div>
            <div class="menu-item" onclick="showSummary()"><div style="font-size:50px">ğŸ“Š</div><span>å³æ™‚åº«å­˜çœ‹</span></div>
            <div class="menu-item" onclick="openCategory('others')"><img src="https://i.postimg.cc/T1pdFnDg/OIP-(1).png"><span>å…¶å®ƒç‰©æ–™</span></div>
        </div>
        <div style="text-align:center; margin-top:25px;">
             <button onclick="window.location.href='https://line.me/ti/p/~noc770817'" style="background:#06C755; color:white; border:none; padding:12px 25px; border-radius:12px; font-weight:bold; font-size:16px;">ğŸ™ï¸ LINE èªéŸ³å ±å‚™å…¥å£</button>
        </div>
    </div>

    <div id="listPage" class="page">
        <div class="header"><button class="back-btn" onclick="showPage('homePage')">â† è¿”å›é¡åˆ¥</button><h2 id="categoryTitle" style="color:white; margin:0;"></h2></div>
        <div id="itemContainer" style="max-width:600px; margin:0 auto; padding:10px;"></div>
        <div class="batch-bar"><button id="batchBtn" class="batch-btn" onclick="submitBatch()">ğŸš€ ä¸€éµå…¨éƒ¨é€å‡º</button></div>
    </div>

    <div id="summaryPage" class="page">
        <div class="header"><button class="back-btn" onclick="location.reload()">â† å›é¦–é </button><h1>å³æ™‚åº«å­˜ç¸½é‡</h1></div>
        <div id="summaryContainer" style="max-width:600px; margin:0 auto; padding:15px; padding-bottom:80px;"></div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBNiATgf4yVR5qZ5CEmGClfm22yjq2fBlI", authDomain: "bayi-inventory.firebaseapp.com", projectId: "bayi-inventory", databaseURL: "https://bayi-inventory-default-rtdb.firebaseio.com", storageBucket: "bayi-inventory.firebasestorage.app", messagingSenderId: "494997600674", appId: "1:494997600674:web:711588fab8d8ae70eb5afb" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let currentMode = '', draft = JSON.parse(localStorage.getItem('bayi_draft')) || {}, savedUser = localStorage.getItem('bayi_user') || "";

        // --- ğŸ“‚ é€™è£¡å°±æ˜¯ä½ è¦çš„å¸³ç¯·å…§éƒ¨åˆ†å€é‚è¼¯ ---
        const categoryData = {
            truss: [
                { title: "ğŸ—ï¸ Truss æœ¬é«”", items: ["3ç±³Truss", "2ç±³Truss", "1ç±³Truss", "60Truss", "50Truss", "40Truss", "30Truss", "25Truss", "20Truss", "15Truss", "10Truss"] },
                { title: "âš™ï¸ è½‰æ¥é…ä»¶", items: ["è½‰æ¥é ­", "10Â°ä¸€é«”è½‰æ¥é ­", "15Â°è½‰æ¥é ­", "10Â°è½‰æ¥é ­", "Cå¤¾", "Trusséµæ¿", "3ç±³Trusså¾Œæ’", "2ç±³Trusså¾Œæ’", "70Trusså´æ‹‰", "50Trusså´æ‹‰"] }
            ],
            tent: [
                { title: "â›º 3ç±³ç³»åˆ— (å¿«é€Ÿå¸³)", items: ["3ç±³å¿«é€Ÿå¸³(ç™½)", "3ç±³å¿«é€Ÿå¸³(ç´…ç™½)", "3ç±³å¿«é€Ÿå¸³(ç´…)", "3ç±³éª¨æ¶(300*300)"] },
                { title: "â›º 6ç±³ç³»åˆ— (å±‹å‹å¸³)", items: ["6ç±³å±‹å‹å¸³(ç™½)", "6ç±³å±‹å‹å¸³(ç´…ç™½)", "6ç±³å±‹å‹å¸³(ç´…)", "6ç±³å±‹å‹å¸³(é€æ˜)", "6ç±³éª¨æ¶(300*600)", "6ç±³éª¨æ¶(600*600)"] },
                { title: "ğŸ› ï¸ å¸³ç¯·é…ä»¶å€", items: ["3ç±³æ°´æºå¸ƒ", "3ç±³åœå¸ƒ(ç™½)", "3ç±³åœå¸ƒ(å¤§ç´…)", "3ç±³å¸³ç¯·ç‡ˆ", "6ç±³æ°´æºå¸ƒ", "6ç±³åœå¸ƒ(ç™½)", "6ç±³å¸³ç¯·ç‡ˆ", "6ç±³é‚Š", "6ç±³è…³", "6ç±³é›çˆª", "ç‡Ÿé‡˜", "æ²™åŒ…"] }
            ],
            others: [
                { title: "ğŸ“¦ èˆå°/Layher", items: ["6x6èˆå°æ¿", "3x6èˆå°æ¿", "Layheræ¿"] },
                { title: "ğŸª‘ æ¡Œæ¤…/æ¡Œå·¾", items: ["æœƒè­°æ¡Œ", "é»‘é‡‘å‰›", "é»å¿ƒæ¤…", "é»‘æ¡Œå·¾", "æœƒè­°æ¡Œæ¡Œå·¾(ç´…å¸ƒ145*270)", "æ¤…å¥—", "èˆå°é»‘åœ 15m*90", "èˆå°é»‘åœ 15m*150", "èˆå°é»‘åœ 120m*150"] },
                { title: "ğŸ”Œ é›»å™¨/é›œé …", items: ["é›»é¢¨æ‰‡", "åŠæ‰‡", "ä¸‰æ­¥æ¢¯", "ä¸€æ­¥æ¢¯", "åƒåœ¾æ¶", "å¢Šç®±", "ç´…é¾", "ä¸‰è§’éŒ", "ä¸‰è§’éŒé€£æ¡¿"] },
                { title: "ğŸªœ é¦¬æ¤…ç³»åˆ—", items: ["12å‘é¦¬æ¤…", "10å‘é¦¬æ¤…", "9å‘é¦¬æ¤…", "8å°ºé¦¬æ¤…", "6å‘é¦¬æ¤…", "5å‘é¦¬æ¤…", "3å‘é¦¬æ¤…"] },
                { title: "ğŸˆ åœ“æ‹±ç³»åˆ—", items: ["12å‘æ‹±", "15å‘æ‹±", "20å‘æ‹±", "24å‘æ‹±", "30å‘æ‹±", "åœ“æ‹±åœå¸ƒ(ç´…)"] }
            ]
        };

        function setMode(mode) { currentMode = mode; document.getElementById('modeTitle').innerText = (mode === 'å–ç”¨' ? 'ğŸ“¤ å‡ºåº«æ¨¡å¼' : 'ğŸ“¥ å…¥åº«æ¨¡å¼'); document.getElementById('actionDate').valueAsDate = new Date(); if(savedUser) document.getElementById('userName').value = savedUser; document.getElementById('batchBtn').style.background = (mode === 'å…¥åº«' ? '#4CAF50' : '#E91E63'); showPage('homePage'); }
        function showPage(id) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function saveUser(name) { localStorage.setItem('bayi_user', name); }
        function saveDraft(name, val) { if (val) draft[name] = val; else delete draft[name]; localStorage.setItem('bayi_draft', JSON.stringify(draft)); }

        function openCategory(cat) {
            document.getElementById('categoryTitle').innerText = (cat === 'truss' ? 'ğŸ—ï¸ Trussé¡' : cat === 'tent' ? 'â›º å¸³ç¯·é¡' : 'ğŸ“¦ å…¶å®ƒç‰©æ–™');
            const container = document.getElementById('itemContainer');
            container.innerHTML = '';
            
            categoryData[cat].forEach(group => {
                const titleDiv = document.createElement('div');
                titleDiv.className = 'sub-header';
                titleDiv.innerText = group.title;
                container.appendChild(titleDiv);

                group.items.forEach(name => {
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    card.innerHTML = `<div style="display:flex; justify-content:space-between; color:#333; margin-bottom:10px;"><b>${name}</b><span id="qty-${name}">...</span></div>
                        <div class="qty-input-group">
                            <input type="number" id="input-${name}" class="input-num" value="${draft[name] || ''}" oninput="saveDraft('${name}', this.value)">
                            <button class="submit-btn" style="background:${currentMode==='å…¥åº«'?'#4CAF50':'#E91E63'}" onclick="submitChange('${name}')">ç¢ºèª</button>
                        </div>`;
                    container.appendChild(card);
                    db.ref('inventory/' + name).on('value', s => { if(document.getElementById(`qty-${name}`)) document.getElementById(`qty-${name}`).innerText = s.val() || 0; });
                });
            });
            showPage('listPage');
        }

        function submitBatch() {
            const user = document.getElementById('userName').value;
            const eventTag = document.getElementById('eventTag').value || "æœªè¨»è¨˜å ´æ¬¡";
            if (!user || Object.keys(draft).length === 0) return alert('è«‹å…ˆé¸æ“‡äººå“¡ä¸¦è¼¸å…¥æ•¸é‡');
            if(confirm('ç¢ºå®šé€å‡ºæ›´æ–°ï¼Ÿ')) {
                Object.keys(draft).forEach(name => {
                    let val = parseInt(draft[name]);
                    let delta = (currentMode === 'å…¥åº«') ? Math.abs(val) : -Math.abs(val);
                    db.ref('inventory/' + name).transaction(c => (c || 0) + delta);
                    db.ref('logs').push({ user, event: eventTag, name, val: delta, date: document.getElementById('actionDate').value, time: new Date().toLocaleString() });
                });
                draft = {}; localStorage.removeItem('bayi_draft'); location.reload();
            }
        }

        function submitChange(name) {
            const user = document.getElementById('userName').value;
            const val = parseInt(document.getElementById('input-' + name).value);
            if (!user || isNaN(val)) return alert('è³‡è¨Šä¸å…¨');
            let delta = (currentMode === 'å…¥åº«') ? Math.abs(val) : -Math.abs(val);
            db.ref('inventory/' + name).transaction(c => (c || 0) + delta);
            db.ref('logs').push({ user, event: document.getElementById('eventTag').value || "å–®ç­†æ›´æ–°", name, val: delta, date: document.getElementById('actionDate').value, time: new Date().toLocaleString() });
            document.getElementById('input-' + name).value = ''; delete draft[name]; 
            localStorage.setItem('bayi_draft', JSON.stringify(draft));
            alert('æˆåŠŸ');
        }

        function showSummary() {
            const container = document.getElementById('summaryContainer');
            container.innerHTML = 'è®€å–ä¸­...';
            db.ref('inventory').once('value', snap => {
                container.innerHTML = '';
                const data = snap.val() || {};
                ['truss', 'tent', 'others'].forEach(catKey => {
                    categoryData[catKey].forEach(group => {
                        const title = document.createElement('div');
                        title.className = 'sub-header';
                        title.innerText = group.title;
                        container.appendChild(title);
                        group.items.forEach(name => {
                            const qty = data[name] || 0;
                            const card = document.createElement('div');
                            card.style.cssText = `background:white; color:#333; margin-bottom:8px; padding:15px; border-radius:12px; display:flex; justify-content:space-between; box-shadow:0 2px 4px rgba(0,0,0,0.2);`;
                            card.innerHTML = `<b>${name}</b><span style="font-size:20px; font-weight:900; color:${qty<0?'#E91E63':'#2196F3'};">${qty}</span>`;
                            container.appendChild(card);
                        });
                    });
                });
            });
            showPage('summaryPage');
        }
    </script>
</body>
</html>
