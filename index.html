<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4A0404">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…«æ¯…åº«å­˜ç®¡ç†ç³»çµ±</title>
    <link rel="apple-touch-icon" href="https://i.postimg.cc/XNCSk29x/å…«æ¯…LOGO.jpg">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg-wine: #4A0404; --btn-white: #FFFFFF; --text-dark: #333; }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg-wine); color: white; margin: 0; padding: 10px; overflow-x: hidden; }
        .page { display: none; padding-bottom: 80px; } .page.active { display: block; }
        .header { text-align: center; padding: 10px 0; background: var(--bg-wine); position: sticky; top: 0; z-index: 100; }
        .mode-container { display: flex; flex-direction: column; gap: 15px; align-items: center; justify-content: flex-start; padding-top: 10px; }
        .mode-btn { width: 100%; padding: 30px; border-radius: 15px; font-size: 28px; font-weight: bold; border: none; cursor: pointer; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn-out { background: #E91E63; } .btn-in { background: #4CAF50; }  
        .form-container { width: 100%; max-width: 500px; margin: 0 auto 15px auto; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; box-sizing: border-box; }
        .form-group { margin-bottom: 12px; } 
        .form-group label { display: block; margin-bottom: 5px; font-size: 14px; font-weight: bold; color: #FFD700; }
        .form-control { width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 18px; box-sizing: border-box; font-weight: bold; }
        .voice-box { display: flex; gap: 8px; align-items: stretch; margin-bottom: 8px; }
        .voice-input { flex: 1; height: 70px; padding: 10px; border-radius: 8px; border: none; font-size: 18px; box-sizing: border-box; resize: none; color: #333; font-weight: bold; }
        .mic-btn { width: 60px; background: #555; border: none; border-radius: 8px; cursor: pointer; font-size: 24px; color: white; flex-shrink: 0; display: flex; align-items: center; justify-content: center;}
        .mic-btn.recording { background: #ff0000; animation: blink 1s infinite; }
        .quick-send-btn { width: 100%; padding: 12px; background: #FFD700; color: #333; border: none; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 500px; margin: 0 auto; }
        .menu-item { background: var(--btn-white); aspect-ratio: 1/1; border-radius: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; padding: 10px; }
        .menu-item img { width: 60px !important; height: 60px !important; object-fit: contain; }
        .menu-item span { color: var(--text-dark); font-weight: bold; font-size: 16px; margin-top: 5px; }
        .item-card { background: white; color: var(--text-dark); border-radius: 12px; padding: 15px; margin-bottom: 10px; }
        .stock-label { color: #E91E63; font-weight: bold; font-size: 16px; }
        .target-label { color: #2196F3; font-weight: bold; font-size: 16px; }
        .qty-input-group { display: flex; align-items: center; gap: 10px; border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; }
        .input-num { width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 5px; text-align: center; font-size: 18px; }
        .submit-btn { flex: 1; color: white; border: none; padding: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .back-btn { background: none; border: 1px solid white; color: white; padding: 8px 12px; margin-bottom: 10px; border-radius: 5px; cursor: pointer; }
        .batch-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #222; padding: 15px; z-index: 999; text-align: center; }
        .batch-btn { width: 90%; max-width: 500px; padding: 15px; border-radius: 10px; font-size: 18px; font-weight: bold; border: none; color: white; cursor: pointer; }
        .sub-group-title { width: 100%; color: #FFD700; padding: 10px 0; margin-top: 15px; font-weight: bold; font-size: 18px; border-bottom: 1px dashed #FFD700; }
    </style>
</head>
<body>

    <div id="modePage" class="page active">
        <div class="header"><h1>å…«æ¯…åº«å­˜ç³»çµ±</h1></div>
        <div class="form-container">
            <div class="form-group">
                <label>ğŸ‘¤ äººå“¡ (åŒæ­¥é¸å–)</label>
                <select id="entryUserName" class="form-control" onchange="syncUser(this.value)"> 
                    <option value="">è«‹é¸æ“‡äººå“¡...</option>
                    <option>é‚±æ­£è±ª</option><option>é‚±å®¥ç‘‹</option><option>å»–æ†å…‰</option><option>æ—ç¿</option><option>è‘£å¤èˆœ</option><option>é»å…‰åº­</option>
                </select>
            </div>
            <div class="form-group">
                <label>ğŸ¤ å¿«é€ŸèªéŸ³å›è¦†</label>
                <div class="voice-box">
                    <textarea id="entryVoiceInput" class="voice-input" placeholder="æŒ‰éº¥å…‹é¢¨èªªè©±..."></textarea>
                    <button id="entryMicBtn" class="mic-btn" onclick="toggleVoice('entry')">ğŸ¤</button>
                </div>
                <button class="quick-send-btn" onclick="quickSendVoice('entry')">ğŸš€ ç›´æ¥é€å‡º</button>
            </div>
        </div>
        <div class="mode-container">
            <button class="mode-btn btn-out" onclick="setMode('å–ç”¨')">ğŸ“¤ å‡ºåº« (æ‹¿å–)</button>
            <button class="mode-btn btn-in" onclick="setMode('å…¥åº«')">ğŸ“¥ å…¥åº« (æ­¸é‚„)</button>
            <button class="back-btn" onclick="showSummary()" style="width:100%; font-size:20px; border: 1px solid #aaa;">ğŸ“Š æŸ¥çœ‹åº«å­˜ç¸½é‡</button>
        </div>
    </div>

    <div id="homePage" class="page">
        <div class="header"><button class="back-btn" onclick="location.reload()">â† å›é¦–é </button><h1 id="modeTitle"></h1></div>
        <div class="form-container">
            <div class="form-group">
                <label>å“¡å·¥å§“å</label>
                <select id="userName" class="form-control" onchange="syncUser(this.value)"> 
                    <option value="">è«‹é¸æ“‡äººå“¡...</option>
                    <option>é‚±æ­£è±ª</option><option>é‚±å®¥ç‘‹</option><option>å»–æ†å…‰</option><option>æ—ç¿</option><option>è‘£å¤èˆœ</option><option>é»å…‰åº­</option>
                </select>
            </div>
            <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="actionDate" class="form-control"></div>
            <div class="form-group">
                <label>èªéŸ³å‚™è¨»</label>
                <div class="voice-box">
                    <textarea id="eventTag" class="voice-input" placeholder="è«‹èªªè©±..."></textarea>
                    <button id="voiceBtn" class="mic-btn" onclick="toggleVoice('home')">ğŸ¤</button>
                </div>
                <button class="quick-send-btn" onclick="quickSendVoice('home')">ğŸš€ ç›´æ¥é€å‡ºèªéŸ³å…§å®¹</button>
            </div>
        </div>
        <div class="menu-grid">
            <div class="menu-item" onclick="openCategory('truss')"><img src="https://i.postimg.cc/GtDsw45n/OIP.png"><span>Trussé¡</span></div>
            <div class="menu-item" onclick="openCategory('tent')"><img src="https://i.postimg.cc/KYxJNfXy/3tent001.png"><span>å¸³ç¯·é¡</span></div>
            <div class="menu-item" onclick="showSummary()"><div style="font-size:50px">ğŸ“Š</div><span>å³æ™‚åº«å­˜çœ‹</span></div>
            <div class="menu-item" onclick="openCategory('others')"><img src="https://i.postimg.cc/T1pdFnDg/OIP-(1).png"><span>å…¶å®ƒç‰©æ–™</span></div>
        </div>
    </div>

    <div id="listPage" class="page">
        <div class="header"><button class="back-btn" onclick="showPage('homePage')">â† è¿”å›é¡åˆ¥</button><h2 id="categoryTitle" style="color:white; margin:0;"></h2></div>
        <div id="itemContainer" style="max-width:600px; margin:0 auto; padding:10px;"></div>
        <div class="batch-bar"><button id="batchBtn" class="batch-btn" onclick="submitBatch()">ğŸš€ ä¸€éµå…¨éƒ¨é€å‡º</button></div>
    </div>

    <div id="summaryPage" class="page">
        <div class="header"><button class="back-btn" onclick="location.reload()">â† å›é¦–é </button><h1>å³æ™‚åº«å­˜ç¸½é‡</h1></div>
        <div id="summaryContainer" style="max-width:600px; margin:0 auto; padding:15px; padding-bottom:80px;"></div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBNiATgf4yVR5qZ5CEmGClfm22yjq2fBlI", authDomain: "bayi-inventory.firebaseapp.com", projectId: "bayi-inventory", databaseURL: "https://bayi-inventory-default-rtdb.firebaseio.com", storageBucket: "bayi-inventory.firebasestorage.app", messagingSenderId: "494997600674", appId: "1:494997600674:web:711588fab8d8ae70eb5afb" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentMode = '', draft = {}, savedUser = localStorage.getItem('bayi_user') || "";
        let currentVoiceTarget = ''; 
        let remoteCategories = {}; // å„²å­˜ä¸‰å±¤çµæ§‹

        function initUser() {
            if(savedUser) {
                document.getElementById('userName').value = savedUser;
                document.getElementById('entryUserName').value = savedUser;
            }
            fetchCategories(); 
        }

        // ä¿®æ”¹ï¼šè®€å–ä¸‰å±¤çµæ§‹
        function fetchCategories() {
            db.ref('categories').on('value', snap => {
                remoteCategories = snap.val() || {};
            });
        }

        function syncUser(val) {
            savedUser = val;
            localStorage.setItem('bayi_user', val);
            if(document.getElementById('userName')) document.getElementById('userName').value = val;
            if(document.getElementById('entryUserName')) document.getElementById('entryUserName').value = val;
        }

        function autoFixText(t) {
            if (!t) return "";
            let res = t;
            const trussPattern = /è·¨å¸|æˆ³å¸|è¸¹[æ­»å±]|è™•æ­»|å‡ºäº‹|å±ˆå°º|ã„”ã„¨ã„š[Ë‹\s]*/gi;
            res = res.replace(trussPattern, "Truss");
            res = res.replace(/æ­»å¤¾|å¸å¤¾|è¥¿å¤¾/g, "Cå¤¾");
            res = res.replace(/ä¸€ç±³/g, "1ç±³").replace(/å…©ç±³|äºŒç±³/g, "2ç±³").replace(/ä¸‰ç±³/g, "3ç±³");
            res = res.replace(/(Truss\s*)+/gi, "Truss ");
            return res.trim();
        }

        let recognition;
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'zh-TW';
            recognition.onresult = (e) => {
                const res = e.results[0][0].transcript;
                const targetId = currentVoiceTarget === 'entry' ? 'entryVoiceInput' : 'eventTag';
                document.getElementById(targetId).value += autoFixText(res) + " ";
                stopVisuals();
            };
            recognition.onend = stopVisuals;
        }

        function toggleVoice(source) {
            currentVoiceTarget = source;
            const btnId = source === 'entry' ? 'entryMicBtn' : 'voiceBtn';
            const btn = document.getElementById(btnId);
            if (btn.classList.contains('recording')) { recognition.stop(); } 
            else { recognition.start(); btn.classList.add('recording'); btn.innerText = "ğŸ›‘"; }
        }

        function stopVisuals() { 
            ['entryMicBtn', 'voiceBtn'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) { btn.classList.remove('recording'); btn.innerText = "ğŸ¤"; }
            });
        }

        function quickSendVoice(source) {
            const user = savedUser;
            const inputId = source === 'entry' ? 'entryVoiceInput' : 'eventTag';
            const note = document.getElementById(inputId).value;
            if(!user || !note) return alert("è«‹ç¢ºèªäººå“¡å·²é¸æ“‡ï¼Œä¸¦èªªè©±éŒ„éŸ³");
            const dateVal = source === 'entry' ? new Date().toISOString().split('T')[0] : document.getElementById('actionDate').value;
            db.ref('logs').push({ user, type: "èªéŸ³å›è¦†", note, date: dateVal, time: new Date().toLocaleString() });
            alert("å›è¦†å·²é€å‡º"); 
            document.getElementById(inputId).value = "";
        }

        // ä¿®æ”¹ï¼šæ”¯æ´åˆ†å±¤é¡¯ç¤º
        function openCategory(cat) {
            const container = document.getElementById('itemContainer'); 
            container.innerHTML = '';
            document.getElementById('categoryTitle').innerText = (cat==='truss'?'ğŸ—ï¸ Trussé¡':cat==='tent'?'â›º å¸³ç¯·é¡':'ğŸ“¦ å…¶å®ƒç‰©æ–™');
            
            const subCats = remoteCategories[cat];
            if (subCats) {
                for (let subTitle in subCats) {
                    // ç•«å‡ºå°å€æ¨™é¡Œ
                    const titleDiv = document.createElement('div');
                    titleDiv.className = 'sub-group-title';
                    titleDiv.innerText = subTitle;
                    container.appendChild(titleDiv);

                    // ç•«å‡ºè©²å°å€å“é …
                    const items = Object.keys(subCats[subTitle]);
                    items.forEach(itemName => {
                        container.appendChild(createItemCard(itemName));
                    });
                }
            } else {
                container.innerHTML = '<div style="padding:20px; text-align:center;">è³‡æ–™è¼‰å…¥ä¸­...</div>';
            }
            showPage('listPage');
        }

        function createItemCard(name) {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <b style="color:#333; flex:1;">${name}</b>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <span class="stock-label" id="qty-${name}">...</span>
                        <span style="color:#ccc">/</span>
                        <span class="target-label" id="target-${name}">0</span>
                    </div>
                </div>
                <div class="qty-input-group">
                    <input type="number" id="input-${name}" class="input-num" value="${draft[name] || ''}" oninput="updateDraft('${name}', this.value)" placeholder="æ•¸é‡">
                    <button class="submit-btn" style="background:${currentMode==='å…¥åº«'?'#4CAF50':'#E91E63'}" onclick="submitChange('${name}')">ç¢ºèª</button>
                </div>`;
            
            db.ref('inventory/' + name).on('value', s => { 
                const el = document.getElementById(`qty-${name}`);
                if(el) el.innerText = s.val() || 0; 
            });

            db.ref('target/' + name).on('value', s => { 
                const el = document.getElementById(`target-${name}`);
                if(el) el.innerText = s.val() || 0; 
            });

            return card;
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('modeTitle').innerText = (mode === 'å–ç”¨' ? 'ğŸ“¤ å‡ºåº«æ¨¡å¼' : 'ğŸ“¥ å…¥åº«æ¨¡å¼');
            document.getElementById('actionDate').valueAsDate = new Date();
            const btn = document.getElementById('batchBtn');
            btn.style.background = (mode === 'å…¥åº«' ? '#4CAF50' : '#E91E63');
            btn.innerText = (mode === 'å…¥åº«' ? 'ğŸ“¥ ä¸€éµå…¨éƒ¨å…¥åº«' : 'ğŸ“¤ ä¸€éµå…¨éƒ¨å‡ºåº«');
            showPage('homePage');
        }

        function showPage(id) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function updateDraft(n, v) { if (v && v !== "0") draft[n] = v; else delete draft[n]; }

        function submitBatch() {
            const user = savedUser;
            const items = Object.keys(draft);
            if (!user || items.length === 0) return alert('è«‹è¼¸å…¥æ•¸é‡');
            if(confirm('ç¢ºå®šé€å‡ºï¼Ÿ')) {
                const event = document.getElementById('eventTag').value || "ç„¡å‚™è¨»";
                items.forEach(name => {
                    let delta = (currentMode === 'å…¥åº«') ? Math.abs(parseInt(draft[name])) : -Math.abs(parseInt(draft[name]));
                    db.ref('inventory/' + name).transaction(c => (c || 0) + delta);
                    db.ref('logs').push({ user, name, val: delta, event, date: document.getElementById('actionDate').value, time: new Date().toLocaleString() });
                });
                draft = {}; alert('é€å‡ºæˆåŠŸ'); location.reload();
            }
        }

        function submitChange(name) {
            const user = savedUser;
            const val = parseInt(document.getElementById('input-' + name).value);
            if (!user || isNaN(val)) return alert('å¡«å¯«äººå“¡èˆ‡æ•¸é‡');
            let delta = (currentMode === 'å…¥åº«') ? Math.abs(val) : -Math.abs(val);
            db.ref('inventory/' + name).transaction(c => (c || 0) + delta);
            db.ref('logs').push({ user, name, val: delta, event: document.getElementById('eventTag').value || "ç„¡å‚™è¨»", date: document.getElementById('actionDate').value, time: new Date().toLocaleString() });
            alert('æˆåŠŸ'); document.getElementById('input-' + name).value = ''; delete draft[name];
        }

        function showSummary() {
            const container = document.getElementById('summaryContainer'); container.innerHTML = 'è¼‰å…¥ä¸­...';
            db.ref('inventory').once('value', snap => {
                const invData = snap.val() || {};
                db.ref('target').once('value', targetSnap => {
                    const targetData = targetSnap.val() || {};
                    container.innerHTML = '';
                    
                    const groupNames = {truss: "ğŸ—ï¸ Truss é¡", tent: "â›º å¸³ç¯·é¡", others: "ğŸ“¦ å…¶ä»–ç‰©æ–™"};

                    for (let mainKey in remoteCategories) {
                        container.innerHTML += `<div class="sub-group-title" style="margin-top:20px; color:#FFD700; background:rgba(0,0,0,0.3); padding:10px;">${groupNames[mainKey] || mainKey}</div>`;
                        
                        const subCats = remoteCategories[mainKey];
                        for (let subTitle in subCats) {
                            container.innerHTML += `<div style="padding:5px 10px; font-size:14px; color:#aaa;">â— ${subTitle}</div>`;
                            const items = Object.keys(subCats[subTitle]);
                            items.forEach(name => {
                                const row = document.createElement('div');
                                row.style.cssText = "background:white; color:black; margin:5px 10px; padding:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;";
                                row.innerHTML = `<span>${name}</span>
                                    <div>
                                        <b style="color:#E91E63;">${invData[name] || 0}</b> 
                                        <span style="color:#ccc; margin:0 4px;">/</span> 
                                        <b style="color:#2196F3;">${targetData[name] || 0}</b>
                                    </div>`;
                                container.appendChild(row);
                            });
                        }
                    }
                });
            });
            showPage('summaryPage');
        }

        window.onload = initUser;
    </script>
</body>
</html>
