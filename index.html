<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…«æ¯…åº«å­˜ç®¡ç†ç³»çµ±-Abelå°ˆå±¬ç‰ˆ</title>
    <style>
        :root { --bg-wine: #4A0404; --btn-white: #FFFFFF; --text-dark: #333; --btn-in: #4CAF50; --btn-out: #E91E63; }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg-wine); color: white; margin: 0; padding: 10px; overflow-x: hidden; }
        .page { display: none; padding-bottom: 80px; } .page.active { display: block; }
        
        /* é¦–é èªéŸ³å…¥å£æ¨£å¼ */
        .title-area { text-align: center; padding: 10px 0; }
        .form-container { max-width: 500px; margin: 0 auto 15px auto; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; box-sizing: border-box; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 5px; color: #FFD700; font-size: 14px; font-weight: bold; }
        .form-control { width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 16px; box-sizing: border-box; background: white; }
        
        .voice-action-box { display: flex; flex-direction: column; gap: 8px; margin-top: 5px; }
        .voice-row { display: flex; gap: 10px; align-items: stretch; }
        .voice-input { flex-grow: 1; height: 90px; border-radius: 8px; border: none; padding: 10px; font-size: 18px; color: #333; resize: none; box-sizing: border-box; font-weight: bold; }
        .mic-btn { width: 65px; background: #555; border: none; border-radius: 8px; font-size: 30px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .mic-btn.recording { background: #ff0000; animation: blink 1s infinite; }
        .full-width-btn { width: 100%; padding: 14px; background: #FFD700; color: #333; border: none; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer; }
        
        @keyframes blink { 50% { opacity: 0.5; } }

        /* å…¥å£å¤§æŒ‰éˆ• */
        .mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 500px; margin: 20px auto; }
        .mode-item { border-radius: 18px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; aspect-ratio: 1/1; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .mode-item span { font-size: 45px; }
        .mode-item b { font-size: 20px; margin-top: 10px; color: white; }

        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 500px; margin: 0 auto; }
        .menu-item { background: var(--btn-white); aspect-ratio: 1/1; border-radius: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; padding: 10px; }
        .menu-item img { width: 60px !important; height: 60px !important; object-fit: contain; }
        .menu-item span { color: var(--text-dark); font-weight: bold; font-size: 18px; margin-top: 5px; }

        .item-card { background: white; color: var(--text-dark); border-radius: 12px; padding: 15px; margin-bottom: 10px; }
        .qty-input-group { display: flex; align-items: center; gap: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .input-num { width: 85px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; }
        .submit-btn { flex: 1; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
        
        .back-btn { background: none; border: 1px solid white; color: white; padding: 8px 12px; margin-bottom: 10px; border-radius: 5px; cursor: pointer; }
        .sub-group-title { width: 100%; color: #FFD700; padding: 10px 0; margin-top: 15px; font-weight: bold; font-size: 18px; border-bottom: 2px solid #FFD700; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>

    <div id="homePage" class="page active">
        <div class="title-area"><h2>å…«æ¯…åº«å­˜ç®¡ç†</h2></div>
        <div class="form-container">
            <div class="form-group">
                <label>å“¡å·¥å§“å</label>
                <select id="userName" class="form-control" onchange="localStorage.setItem('bayi_user', this.value)">
                    <option value="">è«‹é¸æ“‡äººå“¡...</option>
                    <option>é‚±æ­£è±ª</option><option>é‚±å®¥ç‘‹</option><option>å»–æ†å…‰</option><option>æ—ç¿</option><option>è‘£å¤èˆœ</option><option>é»å…‰åº­</option>
                </select>
            </div>
            <div class="form-group">
                <label>èªéŸ³å ±å‚™ / ç•™è¨€ (å¤§å­—é¡¯ç¤º)</label>
                <div class="voice-action-box">
                    <div class="voice-row">
                        <textarea id="eventTag" class="voice-input" placeholder="æŒ‰éº¥å…‹é¢¨èªªè©±..."></textarea>
                        <button id="voiceBtn" class="mic-btn" onclick="toggleSpeech()">ğŸ¤</button>
                    </div>
                    <button class="full-width-btn" onclick="submitNoteOnly()">ğŸš€ ç›´æ¥é€å‡ºå ±å‚™å…§å®¹</button>
                </div>
            </div>
        </div>
        <div class="mode-grid">
            <div class="mode-item" style="background:var(--btn-in);" onclick="setMode(1)"><span>ğŸ“¥</span><b>å…¥åº«æ¨¡å¼</b></div>
            <div class="mode-item" style="background:var(--btn-out);" onclick="setMode(-1)"><span>ğŸ“¤</span><b>å‡ºåº«æ¨¡å¼</b></div>
        </div>
    </div>

    <div id="catPage" class="page">
        <div class="header" style="padding:10px;"><button class="back-btn" onclick="showPage('homePage')">â† è¿”å›</button><h2 id="modeTitle" style="display:inline; margin-left:15px;"></h2></div>
        <div class="menu-grid">
            <div class="menu-item" onclick="openCat('truss')"><img src="https://i.postimg.cc/GtDsw45n/OIP.png"><span>Trusså€</span></div>
            <div class="menu-item" onclick="openCat('tent')"><img src="https://i.postimg.cc/KYxJNfXy/3tent001.png"><span>å¸³ç¯·å€</span></div>
            <div class="menu-item" onclick="showSummary()"><div style="font-size:45px">ğŸ“Š</div><span>å³æ™‚åº«å­˜</span></div>
            <div class="menu-item" onclick="openCat('others')"><img src="https://i.postimg.cc/T1pdFnDg/OIP-(1).png"><span>å…¶å®ƒç‰©æ–™</span></div>
        </div>
    </div>

    <div id="listPage" class="page">
        <div style="padding: 10px;"><button class="back-btn" onclick="showPage('catPage')">â† è¿”å›</button><h2 id="catTitle" style="display:inline; margin-left:15px;"></h2></div>
        <div id="itemContainer" style="max-width:500px; margin: 0 auto; padding: 10px;"></div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBNiATgf4yVR5qZ5CEmGClfm22yjq2fBlI", authDomain: "bayi-inventory.firebaseapp.com", projectId: "bayi-inventory", databaseURL: "https://bayi-inventory-default-rtdb.firebaseio.com" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentMode = 1;

        // --- èªéŸ³è¾¨è­˜èˆ‡ä¿®æ­£ ---
        let recognition;
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'zh-TW';
            recognition.onresult = (e) => {
                let t = e.results[0][0].transcript;
                t = t.replace(/è¸¹[æ­»å±]|ã„”ã„¨ã„š[Ë‹\s]|æˆ³å¸|è·¨å¸|ç±³[åˆ·å‰µè™•å‡ºä¿ƒ]/gi, "ç±³Truss");
                t = t.replace(/[ä¸‰å±±æ‰]ç±³/g, "3ç±³Truss");
                t = t.replace(/[å…©é‡æ¶¼äº®]ç±³/g, "2ç±³Truss");
                t = t.replace(/æ°´æº(?!å¸ƒ)/g, "æ°´æºå¸ƒ");
                document.getElementById('eventTag').value += t + " ";
                stopVisuals();
            };
            recognition.onend = stopVisuals;
        }

        function toggleSpeech() {
            const btn = document.getElementById('voiceBtn');
            if (btn.classList.contains('recording')) { recognition.stop(); } 
            else { recognition.start(); btn.classList.add('recording'); btn.innerText = "ğŸ›‘"; }
        }
        function stopVisuals() { const btn = document.getElementById('voiceBtn'); btn.classList.remove('recording'); btn.innerText = "ğŸ¤"; }

        // --- åˆ†é¡èˆ‡å“é … (ç²¾æº–éª¨æ¶åˆ†é¡) ---
        const trussGroup = ["3ç±³Truss", "2ç±³Truss", "1ç±³Truss", "60Truss", "50Truss", "40Truss", "30Truss", "25Truss", "20Truss", "15Truss", "10Truss", "è½‰æ¥é ­", "Trusséµæ¿", "Trussæ–œæ’"];
        
        const tentMain = ["12å‘æ‹±", "15å‘æ‹±", "20å‘æ‹±", "24å‘æ‹±", "30å‘æ‹±", "3ç±³å¿«é€Ÿå¸³(ç™½)", "3ç±³å¿«é€Ÿå¸³(ç´…ç™½)", "6ç±³é ‚ç¯·(ç™½)"];
        const boneGroup = ["éª¨æ¶300*300", "éª¨æ¶300*600", "éª¨æ¶600*600", "6ç±³éª¨æ–™", "3x6éª¨æ–™"]; // éª¨æ¶ç¨ç«‹å€
        const tentAcc = ["3ç±³æ°´æºå¸ƒ", "6ç±³æ°´æºå¸ƒ", "3ç±³åœå¸ƒ(ç™½)", "6ç±³åœå¸ƒ(ç™½)", "ç‡Ÿé‡˜", "æ²™åŒ…", "å¸³ç¯·ç‡ˆ"];

        const otherGroup = ["6x6èˆå°æ¿", "3x6èˆå°æ¿", "Layheræ¿", "é›»é¢¨æ‰‡", "åŠæ‰‡", "é¦¬æ¤…(12å‘)", "é¦¬æ¤…(9å‘)", "é¦¬æ¤…(6å‘)", "æœƒè­°æ¡Œ", "é»‘é‡‘å‰›", "é»å¿ƒæ¤…", "ç´…é¾", "ä¸‰è§’éŒ", "Cå¤¾"];

        function setMode(m) {
            currentMode = m;
            document.getElementById('modeTitle').innerText = (m === 1 ? 'ğŸ“¥ æ¨¡å¼ï¼šå…¥åº«' : 'ğŸ“¤ æ¨¡å¼ï¼šå‡ºåº«');
            document.getElementById('modeTitle').style.color = (m === 1 ? '#4CAF50' : '#E91E63');
            showPage('catPage');
        }

        function openCat(cat) {
            const container = document.getElementById('itemContainer');
            container.innerHTML = '';
            if(cat === 'truss') {
                container.innerHTML += '<div class="sub-group-title">ğŸ—ï¸ Truss èˆ‡é…ä»¶</div>';
                trussGroup.forEach(n => container.appendChild(createCard(n)));
            } else if(cat === 'tent') {
                container.innerHTML += '<div class="sub-group-title">â›º å¸³ç¯·ä¸»é«”</div>';
                tentMain.forEach(n => container.appendChild(createCard(n)));
                container.innerHTML += '<div class="sub-group-title">ğŸ—ï¸ éª¨æ¶ / éª¨æ–™å°ˆå€</div>'; // éª¨æ¶åˆ†å‡ºä¾†
                boneGroup.forEach(n => container.appendChild(createCard(n)));
                container.innerHTML += '<div class="sub-group-title">ğŸ› ï¸ å¸³ç¯·é…ä»¶</div>';
                tentAcc.forEach(n => container.appendChild(createCard(n)));
            } else {
                container.innerHTML += '<div class="sub-group-title">ğŸ“¦ å…¶ä»–ç‰©æ–™èˆ‡è¨­å‚™</div>';
                otherGroup.forEach(n => container.appendChild(createCard(n)));
            }
            document.getElementById('catTitle').innerText = (cat==='truss'?'Trussé¡':cat==='tent'?'å¸³ç¯·é¡':'å…¶å®ƒç‰©æ–™');
            showPage('listPage');
        }

        function createCard(name) {
            const card = document.createElement('div');
            card.className = 'item-card';
            const color = currentMode === 1 ? '#4CAF50' : '#E91E63';
            card.innerHTML = `<div style="display:flex; justify-content:space-between; font-size:18px;"><b>${name}</b><span id="st-${name}">...</span></div>
                <div class="qty-input-group">
                    <input type="number" id="in-${name}" class="input-num" placeholder="0">
                    <button class="submit-btn" style="background:${color}" onclick="doSubmit('${name}')">${currentMode===1?'ç¢ºèªå…¥åº«':'ç¢ºèªå‡ºåº«'}</button>
                </div>`;
            db.ref('inventory/'+name).on('value', s => { if(document.getElementById('st-'+name)) document.getElementById('st-'+name).innerText = s.val()||0; });
            return card;
        }

        function doSubmit(name) {
            const user = document.getElementById('userName').value;
            const val = parseInt(document.getElementById('in-'+name).value);
            if(!user || isNaN(val)) return alert('è«‹é¸äººå“¡èˆ‡å¡«æ•¸é‡');
            const delta = val * currentMode;
            db.ref('inventory/'+name).transaction(c => (c||0) + delta);
            db.ref('logs').push({ user, name, val: delta, note: document.getElementById('eventTag').value, time: new Date().toLocaleString() });
            alert(name + ' æˆåŠŸ');
            document.getElementById('in-'+name).value = '';
        }

        function submitNoteOnly() {
            const user = document.getElementById('userName').value;
            if(!user) return alert('è«‹é¸äººå“¡');
            db.ref('logs').push({ user, type: "èªéŸ³å ±å‚™", note: document.getElementById('eventTag').value, time: new Date().toLocaleString() });
            alert('å ±å‚™å·²é€å‡º'); document.getElementById('eventTag').value = '';
        }

        function showPage(id) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        window.onload = () => { if(localStorage.getItem('bayi_user')) document.getElementById('userName').value = localStorage.getItem('bayi_user'); };
    </script>
</body>
</html>
