<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4A0404">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…«æ¯…åº«å­˜ç®¡ç†ç³»çµ±</title>
    <link rel="apple-touch-icon" href="https://i.postimg.cc/XNCSk29x/å…«æ¯…LOGO.jpg">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg-wine: #4A0404; --btn-white: #FFFFFF; --text-dark: #333; }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg-wine); color: white; margin: 0; padding: 10px; }
        .page { display: none; padding-bottom: 100px; } 
        .page.active { display: block; }
        .header { text-align: center; padding: 15px 0; background: var(--bg-wine); position: sticky; top: 0; z-index: 100; }
        
        /* è¡¨å–®å®¹å™¨ */
        .form-container { max-width: 500px; margin: 0 auto; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .form-group { margin-bottom: 15px; } 
        .form-group label { display: block; margin-bottom: 8px; font-size: 14px; color: #FFD700; font-weight: bold; }
        .form-control { width: 100%; padding: 12px; border-radius: 10px; border: none; font-size: 16px; box-sizing: border-box; }

        /* èªéŸ³å€å¡Šï¼šç§»è‡³ç¬¬ä¸‰è¡Œ */
        .voice-section { background: rgba(0,0,0,0.4); padding: 15px; border-radius: 15px; margin-top: 10px; border: 2px solid #FFD700; }
        .voice-flex { display: flex; align-items: center; gap: 12px; }
        .voice-btn { background: #555; border: none; border-radius: 50%; width: 60px; height: 60px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 30px; color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .voice-btn.recording { background: #ff0000; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .voice-input { flex-grow: 1; height: 50px; border-radius: 10px; border: none; padding: 0 15px; font-size: 18px; font-weight: bold; color: #222; background: white; }
        .quick-send-btn { background: #FFD700; color: #333; border: none; padding: 0 20px; height: 50px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; }

        /* é¸å–®æ¨£å¼ */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 500px; margin: 25px auto; }
        .menu-item { background: var(--btn-white); aspect-ratio: 1/1; border-radius: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
        .menu-item img { width: 65px !important; height: 65px !important; object-fit: contain; }
        .menu-item span { color: var(--text-dark); font-weight: bold; font-size: 18px; margin-top: 10px; }

        /* å“é …å¡ç‰‡ */
        .item-card { background: white; color: var(--text-dark); border-radius: 15px; padding: 18px; margin-bottom: 12px; }
        .qty-input-group { display: flex; align-items: center; gap: 12px; border-top: 1px solid #eee; padding-top: 12px; margin-top: 10px; }
        .input-num { width: 90px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; text-align: center; font-size: 20px; font-weight: bold; }
        .submit-btn { flex: 1; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        .back-btn { background: none; border: 1px solid white; color: white; padding: 10px 15px; border-radius: 8px; cursor: pointer; }
        .sub-group-title { width: 100%; color: #FFD700; padding: 15px 0 5px 0; margin-top: 20px; font-weight: bold; font-size: 20px; border-bottom: 2px solid #FFD700; }
        .spacer-line { height: 40px; }
    </style>
</head>
<body>

    <div id="modePage" class="page active">
        <div class="header"><h1>å…«æ¯…åº«å­˜ç³»çµ±</h1></div>
        <div style="display: flex; flex-direction: column; gap: 25px; align-items: center; justify-content: center; height: 70vh;">
            <button class="mode-btn" style="width: 85%; padding: 45px; border-radius: 25px; font-size: 32px; font-weight: bold; border: none; color: white; background: #E91E63;" onclick="setMode('å–ç”¨')">ğŸ“¤ å‡ºåº« (æ‹¿å–)</button>
            <button class="mode-btn" style="width: 85%; padding: 45px; border-radius: 25px; font-size: 32px; font-weight: bold; border: none; color: white; background: #4CAF50;" onclick="setMode('å…¥åº«')">ğŸ“¥ å…¥åº« (æ­¸é‚„)</button>
            <button class="back-btn" onclick="showSummary()" style="width:80%; font-size:20px; color: #FFD700; border-color: #FFD700;">ğŸ“Š æŸ¥çœ‹ç›®å‰ç¸½åº«å­˜</button>
        </div>
    </div>

    <div id="homePage" class="page">
        <div class="header"><button class="back-btn" onclick="location.reload()">â† å›é¦–é </button><h1 id="modeTitle"></h1></div>
        
        <div class="form-container">
            <div class="form-group">
                <label>1. é¸æ“‡å“¡å·¥å§“å</label>
                <select id="userName" class="form-control" onchange="saveUser(this.value)"> 
                    <option value="">-- è«‹é»é¸ --</option>
                    <option>é‚±æ­£è±ª</option><option>é‚±å®¥ç‘‹</option><option>å»–æ†å…‰</option><option>æ—ç¿</option><option>è‘£å¤èˆœ</option><option>é»å…‰åº­</option>
                </select>
            </div>

            <div class="form-group">
                <label>2. æ—¥æœŸè¨­å®š</label>
                <input type="date" id="actionDate" class="form-control">
            </div>

            <div class="voice-section">
                <label style="display:block; margin-bottom:8px; color:#FFD700; font-weight:bold;">3. èªéŸ³ç•™è¨€ / è¡“èªå›å ±</label>
                <div class="voice-flex">
                    <button id="voiceBtn" class="voice-btn" onclick="toggleVoiceRecognition()">ğŸ¤</button>
                    <input type="text" id="eventTag" class="voice-input" placeholder="æŒ‰éº¥å…‹é¢¨èªªè©±...">
                    <button class="quick-send-btn" onclick="submitBatch()">ğŸš€ é€å‡º</button>
                </div>
            </div>
        </div>
        
        <div class="menu-grid">
            <div class="menu-item" onclick="openCategory('truss')"><img src="https://i.postimg.cc/GtDsw45n/OIP.png"><span>Trusså€</span></div>
            <div class="menu-item" onclick="openCategory('tent')"><img src="https://i.postimg.cc/KYxJNfXy/3tent001.png"><span>å¸³ç¯·å€</span></div>
            <div class="menu-item" onclick="showSummary()"><div style="font-size:55px">ğŸ“Š</div><span>å³æ™‚åº«å­˜</span></div>
            <div class="menu-item" onclick="openCategory('others')"><img src="https://i.postimg.cc/T1pdFnDg/OIP-(1).png"><span>å…¶å®ƒé…ä»¶</span></div>
        </div>
    </div>

    <div id="listPage" class="page">
        <div class="header"><button class="back-btn" onclick="showPage('homePage')">â† è¿”å›</button><h2 id="categoryTitle"></h2></div>
        <div id="itemContainer" style="max-width:600px; margin:0 auto; padding:10px; padding-bottom: 120px;"></div>
    </div>

    <div id="summaryPage" class="page">
        <div class="header"><button class="back-btn" onclick="location.reload()">â† å›é¦–é </button><h1>åº«å­˜ç¸½è¦½</h1></div>
        <div id="summaryContainer" style="max-width:600px; margin:0 auto; padding:15px;"></div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBNiATgf4yVR5qZ5CEmGClfm22yjq2fBlI", authDomain: "bayi-inventory.firebaseapp.com", projectId: "bayi-inventory", databaseURL: "https://bayi-inventory-default-rtdb.firebaseio.com" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentMode = '', draft = {}, savedUser = localStorage.getItem('bayi_user') || "";

        function autoCorrect(text) {
            let t = text;
            const garbage = ["æˆ‘æ‹¿äº†", "æ¬äº†", "å¸¶äº†", "å€‹", "äº†", "çš„", "ä¸€æ”¯", "ä¸€æ ¹", "æ¬å»", "å›ä¾†"];
            garbage.forEach(g => { t = t.replace(new RegExp(g, "g"), ""); });
            const rules = [
                { reg: /æ³°å±±ç±³|å±±ç±³|ä¸‰ç±³|çŠç±³|3M/g, rep: "3ç±³Truss" },
                { reg: /å…©ç±³|é‡ç±³|æ¶¼ç±³|äº®ç±³|2M/g, rep: "2ç±³Truss" },
                { reg: /ä¸€ç±³|ä¹™ç±³|ä»¥ç±³|1M/g, rep: "1ç±³Truss" },
                { reg: /60[è·¨æ‹‰æ–¯åˆ·Tç±³]+/gi, rep: "60Truss" },
                { reg: /50[è·¨æ‹‰æ–¯åˆ·Tç±³]+/gi, rep: "50Truss" },
                { reg: /40[è·¨æ‹‰æ–¯åˆ·Tç±³]+/gi, rep: "40Truss" },
                { reg: /30[è·¨æ‹‰æ–¯åˆ·Tç±³]+/gi, rep: "30Truss" },
                { reg: /25[è·¨æ‹‰æ–¯åˆ·Tç±³]+/gi, rep: "25Truss" },
                { reg: /20[è·¨æ‹‰æ–¯åˆ·Tç±³]+/gi, rep: "20Truss" },
                { reg: /15[è·¨æ‹‰æ–¯åˆ·Tç±³]+/gi, rep: "15Truss" },
                { reg: /10[è·¨æ‹‰æ–¯åˆ·Tç±³]+/gi, rep: "10Truss" },
                { reg: /[è·¨æ‹‰æ–¯åˆ·å‰µå‡ºè™•ä¿ƒcross]+/gi, rep: "Truss" },
                { reg: /æ­»å¤¾|å¸å¤¾|ç³»å¤¾|Cå¤¾/gi, rep: "Cå¤¾" }
            ];
            rules.forEach(r => { t = t.replace(r.reg, r.rep); });
            return t.replace(/TrussTruss/gi, "Truss").trim();
        }

        let recognition;
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'zh-TW';
            recognition.onresult = (e) => {
                let res = e.results[0][0].transcript;
                document.getElementById('eventTag').value += autoCorrect(res) + " ";
                stopVisuals();
            };
            recognition.onend = stopVisuals;
            recognition.onerror = stopVisuals;
        }

        function toggleVoiceRecognition() {
            const btn = document.getElementById('voiceBtn');
            if (btn.classList.contains('recording')) { recognition.stop(); } 
            else { recognition.start(); btn.classList.add('recording'); btn.innerText = "ğŸ›‘"; }
        }
        function stopVisuals() { const btn = document.getElementById('voiceBtn'); btn.classList.remove('recording'); btn.innerText = "ğŸ¤"; }

        // --- å®Œæ•´å“é …æ¸…å–® ---
        const trussMain = ["3ç±³Truss", "2ç±³Truss", "1ç±³Truss", "60Truss", "50Truss", "40Truss", "30Truss", "25Truss", "20Truss", "15Truss", "10Truss"];
        const trussParts = ["è½‰æ¥é ­", "10Â°ä¸€é«”è½‰æ¥é ­", "15Â°è½‰æ¥é ­", "10Â°è½‰æ¥é ­", "Trusséµæ¿", "Trussæ–œæ’"];
        const tentMain = ["3ç±³å¿«é€Ÿå¸³(ç´…ç™½)", "3ç±³å¿«é€Ÿå¸³(ç™½)", "3ç±³6é ‚æ£š(ç´…)", "6ç±³é ‚ç¯·(ç™½)", "6ç±³é ‚ç¯·(ç´…ç™½)", "6ç±³é ‚ç¯·(ç´…)", "6ç±³é ‚ç¯·(é€æ˜)", "12å‘æ‹±", "15å‘æ‹±", "20å‘æ‹±", "24å‘æ‹±", "30å‘æ‹±", "12å‘é ‚æ£š(ç™½)", "12å‘é ‚æ£š(ç´…ç™½)", "15å‘é ‚æ£š(ç™½)", "15å‘é ‚æ£š(ç´…ç™½)", "20å‘é ‚æ£š(ç™½)", "20å‘é ‚æ£š(ç´…ç™½)", "24å‘é ‚æ£š(ç™½)", "24å‘é ‚æ£š(ç´…ç™½)", "30å‘é ‚æ£š(ç™½)", "30å‘é ‚æ£š(ç´…ç™½)"];
        const skeletonItems = ["éª¨æ¶300*300", "éª¨æ¶300*600", "éª¨æ¶600*600"];
        const tentParts = ["3ç±³åœå¸ƒ(ç™½)", "3ç±³åœå¸ƒ(ç´…)", "3ç±³é ‚ç¯·(ç´…)", "3ç±³å¸³ç¯·ç‡ˆ", "3ç±³æ°´æº", "6ç±³æ°´æºå¸ƒ", "6ç±³åœå¸ƒ(ç™½)", "6ç±³å¸³ç¯·ç‡ˆ", "ç‡Ÿé‡˜", "15å‘é ­åœ", "15å‘é ­åœ(ç´…)", "20å‘é ­åœ", "20å‘é ­åœ(ç´…)", "24å‘é ­åœ", "24å‘é ­åœ(ç´…)", "30å‘é ­åœ", "æ²™åŒ…"];
        const othersItems = ["6x6èˆå°æ¿", "3x6èˆå°æ¿", "Layheræ¿", "é›»é¢¨æ‰‡", "åŠæ‰‡", "ä¸‰æ­¥æ¢¯", "ä¸€æ­¥æ¢¯", "åƒåœ¾æ¶", "å¢Šç®±", "12å‘é¦¬æ¤…", "9å‘é¦¬æ¤…", "8å°ºé¦¬æ¤…", "5å‘é¦¬æ¤…", "3å‘é¦¬æ¤…", "æœƒè­°æ¡Œæ¡Œå·¾(é»‘145*270)", "æœƒè­°æ¡Œæ¡Œå·¾(ç´…145*270)", "æœƒè­°æ¡Œåšæ¡Œå·¾(ç´…145*270)", "é¦™æª³é‡‘æ¤…å¥—", "èˆå°é»‘åœ 15m*90", "èˆå°é»‘åœ 15m*150", "èˆå°é»‘åœ 120m*150", "æœƒè­°æ¡Œ", "é»‘é‡‘å‰›", "é»å¿ƒæ¤…", "ç´…é¾", "ä¸‰è§’éŒ", "ä¸‰è§’éŒé€£æ¡¿", "Cå¤¾"];

        function setMode(mode) { currentMode = mode; document.getElementById('modeTitle').innerText = (mode === 'å–ç”¨' ? 'ğŸ“¤ å‡ºåº«æ¨¡å¼' : 'ğŸ“¥ å…¥åº«æ¨¡å¼'); document.getElementById('actionDate').valueAsDate = new Date(); if(savedUser) document.getElementById('userName').value = savedUser; showPage('homePage'); }

        function openCategory(cat) {
            const container = document.getElementById('itemContainer'); container.innerHTML = '';
            if (cat === 'truss') {
                document.getElementById('categoryTitle').innerText = 'ğŸ—ï¸ Truss é¡åˆ¥';
                container.innerHTML += '<div class="sub-group-title">ğŸ—ï¸ Truss ä¸»é«”</div>';
                trussMain.forEach(n => container.appendChild(createItemCard(n)));
                container.innerHTML += '<div class="sub-group-title">ğŸ› ï¸ Truss é›¶é…ä»¶</div>';
                trussParts.forEach(n => container.appendChild(createItemCard(n)));
            } else if (cat === 'tent') {
                document.getElementById('categoryTitle').innerText = 'â›º å¸³ç¯·é¡åˆ¥';
                container.innerHTML += '<div class="sub-group-title">â›º å¸³ç¯·é ‚æ£š/æ‹±</div>';
                tentMain.forEach(n => container.appendChild(createItemCard(n)));
                container.innerHTML += '<div class="spacer-line"></div><div class="sub-group-title">ğŸ—ï¸ éª¨æ¶çµæ§‹ (300/600)</div>';
                skeletonItems.forEach(n => container.appendChild(createItemCard(n)));
                container.innerHTML += '<div class="spacer-line"></div><div class="sub-group-title">ğŸ› ï¸ å¸³ç¯·/åœå¸ƒé…ä»¶</div>';
                tentParts.forEach(n => container.appendChild(createItemCard(n)));
            } else {
                document.getElementById('categoryTitle').innerText = 'ğŸ“¦ å…¶å®ƒé…ä»¶';
                othersItems.forEach(n => container.appendChild(createItemCard(n)));
            }
            showPage('listPage');
        }

        function createItemCard(name) {
            const card = document.createElement('div'); card.className = 'item-card';
            card.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><b>${name}</b><span id="qty-${name}" style="font-size:22px;">...</span></div>
                <div class="qty-input-group"><input type="number" id="input-${name}" class="input-num" placeholder="0" oninput="updateDraft('${name}', this.value)">
                <button class="submit-btn" style="background:${currentMode==='å…¥åº«'?'#4CAF50':'#E91E63'}" onclick="submitChange('${name}')">ç¢ºèªæ›´æ–°</button></div>`;
            db.ref('inventory/'+name).on('value', s => { if(document.getElementById(`qty-${name}`)) document.getElementById(`qty-${name}`).innerText = s.val() || 0; });
            return card;
        }

        function saveUser(v) { localStorage.setItem('bayi_user', v); }
        function updateDraft(n,v) { if(v && v!=="0") draft[n]=v; else delete draft[n]; }
        function showPage(id) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(id).classList.add('active'); }

        function submitBatch() {
            const user = document.getElementById('userName').value; if(!user) return alert('è«‹å…ˆé¸æ“‡äººå“¡å§“å');
            const event = document.getElementById('eventTag').value || "ç„¡å‚™è¨»";
            const items = Object.keys(draft);
            if(confirm('ç¢ºå®šé€å‡ºè¨˜éŒ„ï¼Ÿ')){
                if(items.length > 0){
                    items.forEach(name => {
                        let delta = (currentMode==='å…¥åº«')?Math.abs(parseInt(draft[name])):-Math.abs(parseInt(draft[name]));
                        db.ref('inventory/'+name).transaction(c=>(c||0)+delta);
                        db.ref('logs').push({ user, name, val: delta, event, date: document.getElementById('actionDate').value, time: new Date().toLocaleString() });
                    });
                } else {
                    db.ref('logs').push({ user, name: "èªéŸ³ç´”å ±å‚™", val: 0, event, date: document.getElementById('actionDate').value, time: new Date().toLocaleString() });
                }
                draft = {}; alert('æˆåŠŸé€å‡º'); location.reload();
            }
        }

        function submitChange(name) {
            const user = document.getElementById('userName').value; if(!user) return alert('è«‹å…ˆé¸æ“‡å§“å');
            const val = parseInt(document.getElementById('input-'+name).value); if(isNaN(val)) return alert('è«‹å¡«æ•¸é‡');
            let delta = (currentMode==='å…¥åº«')?Math.abs(val):-Math.abs(val);
            db.ref('inventory/'+name).transaction(c=>(c||0)+delta);
            db.ref('logs').push({ user, name, val: delta, event: document.getElementById('eventTag').value||"ç„¡å‚™è¨»", date: document.getElementById('actionDate').value, time: new Date().toLocaleString() });
            alert(name + ' æ›´æ–°æˆåŠŸ'); document.getElementById('input-'+name).value=''; delete draft[name];
        }

        function showSummary() {
            const container = document.getElementById('summaryContainer'); container.innerHTML = 'è®€å–ä¸­...';
            db.ref('inventory').once('value', snap => {
                container.innerHTML = ''; const data = snap.val()||{};
                const groups = [ {t:"ğŸ—ï¸ Truss ç¸½è¦½", i:trussMain.concat(trussParts)}, {t:"â›º å¸³ç¯· ç¸½è¦½", i:tentMain.concat(skeletonItems).concat(tentParts)}, {t:"ğŸ“¦ å…¶å®ƒé…ä»¶", i:othersItems} ];
                groups.forEach(g => {
                    const title = document.createElement('div'); title.className = 'sub-group-title'; title.innerText = g.t; container.appendChild(title);
                    g.i.forEach(name => {
                        const row = document.createElement('div'); row.style.cssText = "background:white; color:black; margin:6px 0; padding:12px; border-radius:10px; display:flex; justify-content:space-between; font-weight:bold;";
                        row.innerHTML = `<span>${name}</span><span style="color:#4A0404">${data[name]||0}</span>`; container.appendChild(row);
                    });
                });
            });
            showPage('summaryPage');
        }
    </script>
</body>
</html>
